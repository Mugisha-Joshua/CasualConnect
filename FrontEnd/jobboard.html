<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Board | CasualConnect</title>
  <link rel="stylesheet" href="landingpage.css" />
  <link rel="stylesheet" href="jobboard.css" />
  <style>
    .edit-btn, .delete-btn {
      display: inline-block;
      padding: 0.3rem 0.9rem;
      margin: 0.2rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.96rem;
    }
    .edit-btn { background: #2185d0; color: #fff; }
    .edit-btn:hover { background: #1864ab; }
    .delete-btn { background: #e53935; color: #fff; }
    .delete-btn:hover { background: #b71c1c; }

    .logout-red-btn {
      background: #e53935;
      color: #fff;
      padding: 0.45rem 1.2rem;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      margin-left: 0.5rem;
      transition: background 0.18s;
    }
    .logout-red-btn:hover {
      background: #b71c1c;
    }

    .modal-bg {
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      z-index: 1000;
      background: rgba(0,0,0,0.30);
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .modal-content {
      background: #fff;
      padding: 1.7rem 2.2rem 1.3rem 2.2rem;
      border-radius: 16px;
      max-width: 520px;
      width: 95vw;
      box-shadow: 0 8px 44px rgba(0,0,0,0.13);
      position: relative;
      animation: modalPop 0.18s cubic-bezier(.55,1.55,.68,.53);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 85vh;
      overflow-y: auto;
    }
    @keyframes modalPop {
      from { transform: scale(0.97); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }
    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 1.0rem;
      color: #2185d0;
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: -.5px;
      text-align: center;
    }
    .modal-close {
      position: absolute;
      right: 1.2rem; top: 1.1rem;
      font-size: 1.5rem;
      cursor: pointer;
      font-weight: 700;
      color: #888;
      background: none;
      border: none;
      outline: none;
      transition: color 0.2s;
      z-index: 2;
    }
    .modal-close:hover { color: #e53935; }
    #editJobForm {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    #editJobForm label {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.18rem;
      font-size: 1.02rem;
    }
    #editJobForm input, #editJobForm textarea, #editJobForm select {
      border: 1.1px solid #d0d3d8;
      border-radius: 6px;
      padding: 0.60rem 0.95rem;
      font-size: 1.04rem;
      margin-bottom: 0;
      background: #f7f9fa;
      transition: border 0.17s;
      width: 100%;
      box-sizing: border-box;
    }
    #editJobForm input:focus, #editJobForm textarea:focus, #editJobForm select:focus {
      border-color: #2185d0;
      background: #fff;
      outline: none;
    }
    #editJobForm .form-row {
      display: flex;
      gap: 1.1rem;
      margin-bottom: 0.1rem;
    }
    #editJobForm .form-row > div {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #editJobForm textarea {
      min-height: 48px;
      max-height: 90px;
      resize: vertical;
    }
    #editJobForm .edit-btn {
      padding: 0.75rem 0;
      font-size: 1.10rem;
      margin: 0.18rem 0 0 0;
      background: #2185d0;
      border-radius: 6px;
      font-weight: 700;
      letter-spacing: 0.4px;
      transition: background 0.18s;
      border: none;
      color: #fff;
      width: 100%;
    }
    #editJobForm .edit-btn:hover {
      background: #1864ab;
    }
    @media (max-width: 700px) {
      .modal-content { padding: 1.1rem 0.6rem 1.2rem 0.6rem; max-width: 99vw;}
      #editJobForm .form-row { flex-direction: column; gap: 0.3rem; }
    }
  </style>
</head>
<body>
  <!-- Responsive Navbar -->
  <header>
    <div class="logo">CasualConnect</div>
    <div class="hamburger" onclick="toggleMenu()">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <nav>
      <div class="nav-container" id="navContainer">
        <div class="nav-links" id="navLinks">
          <!-- JS will insert links here -->
        </div>
        <div class="nav-buttons" id="navButtons">
          <!-- JS will insert buttons here -->
        </div>
      </div>
    </nav>
  </header>

  <main class="job-board-container">
     <section class="search-title-section">
      <h1 class="job-search-title">Find Jobs Near You</h1>
    </section>
    <section class="filters">
      <form class="filter-form" id="filterForm" autocomplete="off">
        <input type="text" name="search" placeholder="Search jobs..." class="filter-input" />
        <select name="location" class="filter-select">
          <option value="">All Locations</option>
          <option value="Kigali">Kigali</option>
          <option value="Huye">Huye</option>
          <option value="Musanze">Musanze</option>
          <option value="Rubavu">Rubavu</option>
          <option value="Muhanga">Muhanga</option>
          <option value="Rwamagana">Rwamagana</option>
        </select>
        <select name="category" class="filter-select">
          <option value="">All Categories</option>
          <option value="Domestic Work">Cleaning</option>
          <option value="Construction">Construction</option>
          <option value="Shop Assistant">Retail</option>
          <option value="Gardener">Gardening</option>
          <option value="Delivery Rider">Delivery</option>
          <option value="Mover">Mover</option>
          <option value="Babysitting">Babysitting</option>
          <option value="Painter">Painting</option>
          <option value="Plumber">Plumbing</option>
          <option value="Pet Care">Pet Care</option>
          <option value="Event Cleaner">Event Cleaning</option>
        </select>
        <button type="submit" class="search-btn" style="background:#00bfff;color:#fff;border:none;padding:0.7rem 1.3rem;border-radius:8px;font-weight:600;cursor:pointer;">Search</button>
      </form>
    </section>
    <section class="job-cards" id="jobCards">
      <!-- The static jobs will be rendered here from JS below! -->
    </section>
  </main>
  <footer>
    &copy; 2025 CasualConnect. Designed for community impact.
  </footer>

  <!-- Modal for editing jobs -->
  <div class="modal-bg" id="editModalBg">
    <div class="modal-content">
      <span class="modal-close" id="closeEditModal">&times;</span>
      <h3>Edit Job</h3>
      <form id="editJobForm">
        <div class="form-row">
          <div>
            <label for="editTitle">Title</label>
            <input type="text" id="editTitle" required>
          </div>
          <div>
            <label for="editCompany">Company</label>
            <input type="text" id="editCompany" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label for="editLocation">Location</label>
            <input type="text" id="editLocation" required>
          </div>
          <div>
            <label for="editType">Type</label>
            <select id="editType" required>
              <option value="">Select Type</option>
              <option value="part-time">Part-time</option>
              <option value="full-time">Full-time</option>
              <option value="casual">Casual</option>
              <option value="temporary">Temporary</option>
              <option value="contract">Contract</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label for="editDescription">Description</label>
            <textarea id="editDescription" required></textarea>
          </div>
          <div>
            <label for="editTelephone">Telephone</label>
            <input type="tel" id="editTelephone" required>
          </div>
        </div>
        <button type="submit" class="edit-btn">Update</button>
      </form>
    </div>
  </div>

  <script>
    // Hamburger menu toggle for responsive navbar
    function toggleMenu() {
      const nav = document.getElementById("navContainer");
      nav.classList.toggle("show");
    }
  </script>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAVaPpzeyRy9E-qoUPqP9IbsuVNMkisRwI",
      authDomain: "casualconnect-001.firebaseapp.com",
      projectId: "casualconnect-001",
      storageBucket: "casualconnect-001.appspot.com",
      messagingSenderId: "244256750220",
      appId: "1:244256750220:web:a69d2413c3042c7c3cd9a9"
    };

    let app;
    if (!getApps().length) {
      app = initializeApp(firebaseConfig);
    } else {
      app = getApps()[0];
    }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- STATIC JOBS DATA ---
    const staticJobs = [
      {
        id: "static-tutor",
        title: "Tutor",
        company: "African Leadership University",
        location: "Kicukiro, Kigali",
        type: "Temporary",
        description: "I need someone to tutor my child. He is in s4 MPC and his weakest subject is Mathematics.",
        image: "tutor.jpg",
        telephone: "+250789078333",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static1",
        title: "House Cleaner",
        company: "CleanCo",
        location: "Kigali",
        type: "Domestic Work",
        description: "Seeking reliable cleaner for part-time domestic work. Flex hours, weekly pay.",
        image: "homecleaner.jpg",
        telephone: "+250123456789",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static2",
        title: "Mason Worker",
        company: "MasonWorks",
        location: "Huye",
        type: "Construction",
        description: "Looking for skilled mason for ongoing project. Daily lunch provided.",
        image: "mason.jpg",
        telephone: "+250987654321",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static3",
        title: "Shop Assistant",
        company: "ShopMart",
        location: "Musanze",
        type: "Shop Assistant",
        description: "Friendly shop assistant needed for busy retail store. Training provided.",
        image: "shopassistant.jpg",
        telephone: "+250112233445",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static4",
        title: "Gardener",
        company: "GreenThumb",
        location: "Kigali",
        type: "Gardener",
        description: "Part-time gardener for home and office lawns. Experience preferred.",
        image: "gardener.jpg",
        telephone: "+250223344556",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static5",
        title: "Delivery Rider",
        company: "QuickDeliver",
        location: "Huye",
        type: "Delivery Rider",
        description: "Motorcycle delivery rider for food & parcels. Flexible shifts.",
        image: "deliverydriver2.webp",
        telephone: "+250334455667",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static6",
        title: "House Mover",
        company: "MoveIt",
        location: "Kigali",
        type: "Mover",
        description: "Assist with furniture moving for a local family. Good physical fitness required.",
        image: "housemover.jpg",
        telephone: "+250556677889",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static7",
        title: "Babysitter",
        company: "FamilyCare",
        location: "Kigali, Gasabo",
        type: "Babysitting",
        description: "Watch and play with two children in the afternoons. Snacks included.",
        image: "babysitter.jpg",
        telephone: "+250667788990",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static8",
        title: "Painter",
        company: "ColorHomes",
        location: "Musanze",
        type: "Painter",
        description: "Help paint interior/exterior of new homes. Materials provided. Team work.",
        image: "https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=600&q=80",
        telephone: "+250778899001",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static9",
        title: "Plumber Helper",
        company: "PlumbPro",
        location: "Muhanga",
        type: "Plumber",
        description: "Assist a professional plumber with simple tasks and carrying equipment.",
        image: "https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80",
        telephone: "+250889900112",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static10",
        title: "Pet Walker",
        company: "PetFriends",
        location: "Kigali, Remera",
        type: "Pet Care",
        description: "Walk two friendly dogs each evening. Must love animals!",
        image: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80",
        telephone: "+250991122334",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static11",
        title: "Event Cleaner",
        company: "EventSparkle",
        location: "Rwamagana",
        type: "Event Cleaner",
        description: "Help clean up after a wedding event. Evening work, team provided.",
        image: "https://images.unsplash.com/photo-1465101178521-c1a9136a3bba?auto=format&fit=crop&w=600&q=80",
        telephone: "+250221133445",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static12",
        title: "Shop Helper",
        company: "ShopMart",
        location: "Rubavu",
        type: "Shop Assistant",
        description: "Assist customers and organize shelves in a busy shop market. Flexible schedule.",
        image: "https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=600&q=80",
        telephone: "+250331122556",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static13",
        title: "Community Gardener",
        company: "GreenThumb",
        location: "Kigali, Kicukiro",
        type: "Gardener",
        description: "Help maintain community gardens. All tools provided.",
        image: "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80",
        telephone: "+250445566778",
        email: "",
        postedBy: "Admin",
        isStatic: true
      },
      {
        id: "static14",
        title: "Delivery Helper",
        company: "QuickDeliver",
        location: "Kigali City",
        type: "Delivery Rider",
        description: "Support a busy food delivery rider with pickups and drop-offs. Know the city well.",
        image: "https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=600&q=80",
        telephone: "+250556688999",
        email: "",
        postedBy: "Admin",
        isStatic: true
      }
    ];

    // --- ADD STATIC JOBS TO FIRESTORE (ONCE) ---
    async function addStaticJobsIfNotExist() {
      const jobsRef = collection(db, "jobs");
      const dbJobsSnap = await getDocs(jobsRef);
      const dbTitles = new Set();
      dbJobsSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.title && data.isStatic) dbTitles.add(data.title + "___STATIC");
        else if (data.title) dbTitles.add(data.title);
      });
      for (const job of staticJobs) {
        const key = job.title + (job.isStatic ? "___STATIC" : "");
        if (!dbTitles.has(key)) {
          const jobToAdd = {...job};
          delete jobToAdd.id;
          await addDoc(jobsRef, jobToAdd);
        }
      }
    }

    // NAVBAR LOGIC (unchanged)
    function renderNav(loggedIn, role) {
      let navLinks = `
        <a href="landingpage.html">Home</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      `;
      if (loggedIn) {
        navLinks += `<a href="jobboard.html">Job Board</a>`;
        if (role === "employer") {
          navLinks += `<a href="postjob.html" id="postJobLink">Post a Job</a>`;
        }
      }
      document.getElementById("navLinks").innerHTML = navLinks;

      let navButtons = "";
      if (loggedIn) {
        navButtons = `<button id="logoutBtn" class="logout-red-btn">Logout</button>`;
      } else {
        navButtons = `
          <a href="login.html" class="login-btn">Login</a>
          <a href="login.html" class="get-started-btn">Get Started</a>
        `;
      }
      document.getElementById("navButtons").innerHTML = navButtons;

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.onclick = function() {
          signOut(auth).then(() => {
            localStorage.clear();
            renderNav(false, null);
            window.location.href = "landingpage.html";
          });
        };
      }
    }

    let loggedInUser = null;
    let loggedInEmail = null;
    let loggedInRole = null;

    function getCurrentUserInfo(user) {
      let role = "";
      let name = "";
      let email = "";
      if (user) {
        email = user.email;
        if (user.displayName && user.displayName.includes('|')) {
          [role, name] = user.displayName.split('|');
        } else {
          role = localStorage.getItem('userRole');
          name = localStorage.getItem('userName');
        }
      }
      return { role, name, email };
    }

    // --- JOB DISPLAY/CRUD LOGIC UPDATED FOR FIRESTORE ---
    const jobCards = document.getElementById('jobCards');
    let editingJobId = null;
    let allPostedJobs = [];

    // Load jobs from Firestore
    async function loadFirestoreJobs() {
      let jobs = [];
      try {
        const snapshot = await getDocs(collection(db, "jobs"));
        snapshot.forEach(docSnap => {
          jobs.push({ ...docSnap.data(), id: docSnap.id });
        });
      } catch (e) { }
      return jobs;
    }

    async function loadJobs() {
      const postedJobs = await loadFirestoreJobs();
      allPostedJobs = postedJobs;
      return postedJobs;
    }

    function renderJobs(jobs, userEmail, userRole) {
      jobCards.innerHTML = "";
      if (!jobs || jobs.length === 0) {
        jobCards.innerHTML = "<p>No jobs found.</p>";
        return;
      }
      for (const job of jobs) {
        let controls = "";
        let showApply = true;
        if (
          userRole === "employer" &&
          job.email &&
          job.email === userEmail &&
          !job.isStatic
        ) {
          controls = `
            <button class="edit-btn" data-jobid="${job.id}">Edit</button>
            <button class="delete-btn" data-jobid="${job.id}">Delete</button>
          `;
          showApply = false;
        }
        let contactInfo = "";
        if (job.telephone && job.telephone !== "") {
          contactInfo = `Contact: <a href="tel:${job.telephone}">${job.telephone}</a>`;
        } else if (job.email && job.email !== "") {
          contactInfo = `Contact: <a href="mailto:${job.email}">${job.email}</a>`;
        }

        jobCards.innerHTML += `
          <article class="job-card" data-category="${job.type || ""}">
            <img src="${job.image || 'jobdefault.jpg'}" alt="${job.title}" class="job-image">
            <div class="job-card-content">
              <h2 class="job-title">${job.title}</h2>
              <p class="job-location">${job.location}</p>
              <p class="job-description">${job.description}</p>
              <p class="job-contact">${contactInfo}</p>
              ${controls}
              ${showApply ? '<button class="apply-btn">Apply</button>' : ''}
            </div>
          </article>
        `;
      }
    }

    function openEditModal(job) {
      editingJobId = job.id;
      document.getElementById('editTitle').value = job.title;
      document.getElementById('editCompany').value = job.company || "";
      document.getElementById('editLocation').value = job.location || "";
      document.getElementById('editType').value = job.type || "";
      document.getElementById('editDescription').value = job.description || "";
      document.getElementById('editTelephone').value = job.telephone || "";
      document.getElementById('editModalBg').style.display = "flex";
    }

    document.getElementById('closeEditModal').onclick = () => {
      document.getElementById('editModalBg').style.display = "none";
      editingJobId = null;
    };
    document.getElementById('editModalBg').onclick = (e) => {
      if (e.target.id === 'editModalBg') {
        document.getElementById('editModalBg').style.display = "none";
        editingJobId = null;
      }
    };

    document.getElementById('editJobForm').onsubmit = async function(e) {
      e.preventDefault();
      const job = allPostedJobs.find(j => j.id === editingJobId);
      if (job) {
        const updated = {
          title: document.getElementById('editTitle').value.trim(),
          company: document.getElementById('editCompany').value.trim(),
          location: document.getElementById('editLocation').value.trim(),
          type: document.getElementById('editType').value,
          description: document.getElementById('editDescription').value.trim(),
          telephone: document.getElementById('editTelephone').value.trim()
        };
        try {
          await updateDoc(doc(db, "jobs", job.id), updated);
          const jobs = await loadJobs();
          renderJobs(jobs, loggedInEmail, loggedInRole);
          document.getElementById('editModalBg').style.display = "none";
          editingJobId = null;
        } catch (err) {
          alert("Failed to update job. Please try again.");
        }
      }
    };

    jobCards.onclick = async function(e) {
      if (e.target.classList.contains('edit-btn')) {
        const jobId = e.target.getAttribute('data-jobid');
        const job = allPostedJobs.find(j => j.id === jobId);
        if (job) openEditModal(job);
      }
      if (e.target.classList.contains('delete-btn')) {
        const jobId = e.target.getAttribute('data-jobid');
        if (!confirm('Are you sure you want to delete this job?')) return;
        try {
          await deleteDoc(doc(db, "jobs", jobId));
          const jobs = await loadJobs();
          renderJobs(jobs, loggedInEmail, loggedInRole);
        } catch (err) {
          alert("Failed to delete job. Please try again.");
        }
      }
    };

    document.getElementById('filterForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const search = form.search.value.trim().toLowerCase();
      const location = form.location.value;
      const category = form.category.value;
      const jobs = await loadJobs();
      const filtered = jobs.filter(job => {
        let matches = true;
        if (search) {
          matches = (
            job.title.toLowerCase().includes(search) ||
            (job.company && job.company.toLowerCase().includes(search)) ||
            job.description.toLowerCase().includes(search)
          );
        }
        if (location) matches = matches && job.location === location;
        if (category) matches = matches && job.type === category;
        return matches;
      });
      renderJobs(filtered, loggedInEmail, loggedInRole);
    };

    onAuthStateChanged(auth, async (user) => {
      loggedInUser = user;
      const { role, email } = getCurrentUserInfo(user);
      loggedInEmail = email;
      loggedInRole = role;
      renderNav(!!user, role);
      // Add static jobs to DB if not present
      await addStaticJobsIfNotExist();
      const jobs = await loadJobs();
      renderJobs(jobs, loggedInEmail, loggedInRole);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      if (!loggedInUser) {
        renderNav(false, null);
        await addStaticJobsIfNotExist();
        const jobs = await loadJobs();
        renderJobs(jobs, null, null);
      }
    });
  </script>
</body>
</html>